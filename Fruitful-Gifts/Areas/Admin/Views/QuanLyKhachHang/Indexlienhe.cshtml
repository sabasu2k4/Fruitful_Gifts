@using Fruitful_Gifts.Database
@model List<LienHe>



@{
    Layout = "_LayoutAdmin";
}

<div class="container py-4">
    <h2 class="mb-4 text-center text-primary">Quản Lý Liên Hệ</h2>

    <div class="table-responsive shadow-sm rounded" style="background: white;">
        <table class="table table-hover align-middle" id="statusTable">
            <thead class="table-dark text-center">
                <tr>
                    <th style="width:5%;">STT</th>
                    <th style="width:15%;">HỌ VÀ TÊN</th>
                    <th style="width:15%;">EMAIL</th>
                    <th style="width:10%;">SDT</th>
                    <th style="width:15%;">THỜI GIAN GỬI</th>
                    <th style="width:10%;">TRẠNG THÁI</th>
                    <th style="width:15%;">NHÂN VIÊN XỬ LÝ</th>
                    <th style="width:5%;">Cập nhật</th>
                    <th style="width:5%;">Xóa</th>
                    <th style="width:5%;">Chi tiết</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr class="status-row" data-status="@item.TrangThai">
                        <td class="text-center">@item.MaLh</td>
                        <td>@item.HoTen</td>
                        <td>@item.Email</td>
                        <td class="text-center">@item.Sdt</td>
                        <td class="text-center">
                            @(item.ThoiGianGui.HasValue ? item.ThoiGianGui.Value.ToString("dd/MM/yyyy HH:mm") : "")
                        </td>
                        <td class="text-center">
                            @if (item.TrangThai)
                            {
                                <span class="badge bg-success">Đã xử lý</span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark">Chưa xử lý</span>
                            }
                        </td>
                        <td>@(item.MaNvNavigation?.TenNv ?? "Chưa có người xử lý")</td>
                        <td class="text-center">
                            @if (!item.TrangThai)
                            {
                                <button class="btn btn-sm btn-success"
                                        title="Cập nhật trạng thái"
                                        onclick="return confirm('Bạn có chắc chắn muốn cập nhật trạng thái?') && capNhatTrangThai(@item.MaLh)">
                                    <i class="bi bi-check2-circle"></i>
                                </button>
                            }
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-danger"
                                    title="Xóa liên hệ"
                                    onclick="return confirm('Bạn có chắc chắn muốn xóa liên hệ này?') && xoaLienHe(@item.MaLh)">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-info"
                                    title="Xem chi tiết"
                                    onclick="toggleDetails(@item.MaLh)">
                                <i class="bi bi-info-square"></i>
                            </button>
                        </td>
                    </tr>
                    <tr class="detail-row bg-light" id="detail-@item.MaLh" style="display: none;">
                        <td colspan="10" class="px-4 py-3 text-break">
                            <strong>Nội dung:</strong>
                            <p class="mb-0">@item.NoiDung</p>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Toast notification -->
    <div class="position-fixed top-0 end-0 p-3 mt-3" style="z-index: 1100">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Thông báo</strong>
                <small>Vừa xong</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastBody">
                Nội dung thông báo
            </div>
        </div>
    </div>
</div>
<!-- Phân trang -->
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
            <a class="page-link" href="@Url.Action("Indexlienhe", new { page = ViewBag.CurrentPage - 1 })"> << </a>
        </li>

        @for (int i = 1; i <= ViewBag.TotalPages; i++)
        {
            <li class="page-item @(ViewBag.CurrentPage == i ? "active" : "")">
                <a class="page-link" href="@Url.Action("Indexlienhe", new { page = i })">@i</a>
            </li>
        }

        <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
            <a class="page-link" href="@Url.Action("Indexlienhe", new { page = ViewBag.CurrentPage + 1 })">>></a>
        </li>
    </ul>
</nav>
<style>
    body {
        background-color: #f8f9fa;
    }

    h2 {
        font-weight: 700;
        letter-spacing: 1px;
    }

    .table-hover tbody tr:hover {
        background-color: #e9f5ff;
    }

    .btn-sm i {
        font-size: 1.2rem;
        vertical-align: middle;
    }

    .detail-row td {
        border-top: none !important;
    }

    .detail-row p {
        white-space: pre-wrap;
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.js"></script>

<script>
    function toggleDetails(id) {
        const detailRow = document.getElementById(`detail-${id}`);
        if (detailRow.style.display === 'none') {
            detailRow.style.display = 'table-row';
        } else {
            detailRow.style.display = 'none';
        }
    }

    function showToast(title, message, isSuccess = true) {
        const toastElement = document.getElementById('liveToast');
        const toastTitle = document.getElementById('toastTitle');
        const toastBody = document.getElementById('toastBody');

        toastTitle.textContent = title;
        toastBody.textContent = message;

        if (isSuccess) {
            toastElement.classList.remove('bg-danger');
            toastElement.classList.add('bg-success', 'text-white');
        } else {
            toastElement.classList.remove('bg-success');
            toastElement.classList.add('bg-danger', 'text-white');
        }

        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    }

    function xoaLienHe(id) {
        $.ajax({
            url: '@Url.Action("XoaLienHe", "QuanLyKhachHang")',
            type: 'POST',
            data: { maLh: id },
            success: function (response) {
                if (response.success) {
                    showToast('Thành công', response.message, true);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('Lỗi', response.message, false);
                }
            },
            error: function () {
                showToast('Lỗi', 'Có lỗi xảy ra!', false);
            }
        });
    }

    function capNhatTrangThai(id) {
        $.ajax({
            url: '@Url.Action("CapNhatTrangThai", "QuanLyKhachHang")',
            type: 'POST',
            data: { maLh: id },
            success: function (response) {
                if (response.success) {
                    showToast('Thành công', response.message, true);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('Lỗi', response.message, false);
                }
            },
            error: function () {
                showToast('Lỗi', 'Có lỗi xảy ra!', false);
            }
        });
    }
</script>
