@{
    ViewData["Title"] = "Thống kê hiệu suất sản phẩm";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";

    // Convert all values to decimal for consistent calculations
    decimal avgSanPham = ViewBag.AvgSanPham != null ? Convert.ToDecimal(ViewBag.AvgSanPham) : 0m;
    decimal avgGioQua = ViewBag.AvgGioQua != null ? Convert.ToDecimal(ViewBag.AvgGioQua) : 0m;

    // Calculate thresholds
    decimal minBanChaySanPham = Math.Max(avgSanPham * 1.5m, 5m);
    decimal maxBanKemSanPham = Math.Min(avgSanPham * 0.5m, 2m);
    decimal minBanChayGioQua = Math.Max(avgGioQua * 1.5m, 3m);
    decimal maxBanKemGioQua = Math.Min(avgGioQua * 0.5m, 1m);
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2 class="text-center font-weight-bold text-primary">@ViewData["Title"]</h2>
            <p class="text-muted text-center">Phân tích hiệu suất bán hàng theo sản phẩm và giỏ quà</p>
        </div>
    </div>

    <!-- Criteria information -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="alert alert-primary">
                <i class="fas fa-info-circle mr-2"></i>
                <strong>Tiêu chí xếp loại:</strong>
                <ul class="mb-0">
                    <li><strong>Sản phẩm bán chạy:</strong> ≥ @minBanChaySanPham.ToString("N0") sản phẩm (≥ 150% trung bình hoặc tối thiểu 5 sản phẩm)</li>
                    <li><strong>Sản phẩm bán kém:</strong> ≤ @maxBanKemSanPham.ToString("N0") sản phẩm (≤ 50% trung bình hoặc tối đa 2 sản phẩm)</li>
                    <li><strong>Giỏ quà bán chạy:</strong> ≥ @minBanChayGioQua.ToString("N0") giỏ (≥ 150% trung bình hoặc tối thiểu 3 giỏ)</li>
                    <li><strong>Giỏ quà bán kém:</strong> ≤ @maxBanKemGioQua.ToString("N0") giỏ (≤ 50% trung bình hoặc tối đa 1 giỏ)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Time information -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="alert alert-secondary py-2">
                <i class="fas fa-calendar-alt mr-2"></i>
                <strong>Thời gian:</strong>
                @(string.IsNullOrEmpty(ViewBag.FromDate) ? "Tất cả" : DateTime.ParseExact(ViewBag.FromDate, "yyyy-MM-dd", null).ToString("dd/MM/yyyy"))
                đến
                @(string.IsNullOrEmpty(ViewBag.ToDate) ? "nay" : DateTime.ParseExact(ViewBag.ToDate, "yyyy-MM-dd", null).ToString("dd/MM/yyyy"))
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-secondary py-2">
                <i class="fas fa-chart-line mr-2"></i>
                <strong>Trung bình:</strong>
                @avgSanPham.ToString("N0") sản phẩm/loại |
                @avgGioQua.ToString("N0") giỏ quà/loại
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Best selling products -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-trophy mr-2"></i>Top @ViewBag.SanPhamBanChay.Count sản phẩm bán chạy
                        </h4>
                        <span class="badge bg-white text-success">≥ @minBanChaySanPham.ToString("N0")</span>
                    </div>
                </div>
                <div class="card-body">
                    @if (ViewBag.SanPhamBanChay.Count > 0)
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th width="60%">Tên sản phẩm</th>
                                        <th width="40%" class="text-right">Số lượng bán</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var sp in ViewBag.SanPhamBanChay)
                                    {
                                        decimal tongSoLuong = Convert.ToDecimal(sp.TongSoLuong);
                                        <tr>
                                            <td>
                                                @sp.TenSp
                                                @if (sp.TenSp.Contains("8/3") || sp.TenSp.Contains("20/10"))
                                                {
                                                    <span class="badge badge-pill badge-warning ml-2">Mùa vụ</span>
                                                }
                                            </td>
                                            <td class="text-right font-weight-bold text-success">
                                                @tongSoLuong.ToString("N0")
                                                @if (tongSoLuong >= avgSanPham * 2)
                                                {
                                                    <span class="badge badge-pill badge-success ml-2">Xuất sắc</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-info-circle mr-2"></i>
                            Không có sản phẩm nào đạt ngưỡng bán chạy
                        </div>
                    }
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">Cập nhật lúc @DateTime.Now.ToString("HH:mm dd/MM/yyyy")</small>
                </div>
            </div>
        </div>

        <!-- Poor selling products -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-warning text-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Top @ViewBag.SanPhamBanKem.Count sản phẩm bán kém
                        </h4>
                        <span class="badge bg-white text-warning">≤ @maxBanKemSanPham.ToString("N0")</span>
                    </div>
                </div>
                <div class="card-body">
                    @if (ViewBag.SanPhamBanKem.Count > 0)
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th width="60%">Tên sản phẩm</th>
                                        <th width="40%" class="text-right">Số lượng bán</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var sp in ViewBag.SanPhamBanKem)
                                    {
                                        decimal tongSoLuong = Convert.ToDecimal(sp.TongSoLuong);
                                        <tr>
                                            <td>@sp.TenSp</td>
                                            <td class="text-right font-weight-bold text-warning">
                                                @tongSoLuong.ToString("N0")
                                                @if (tongSoLuong == 0)
                                                {
                                                    <span class="badge badge-pill badge-danger ml-2">Không bán được</span>
                                                }
                                                else if (tongSoLuong <= 2)
                                                {
                                                    <span class="badge badge-pill badge-warning ml-2">Rất thấp</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle mr-2"></i>
                            Không có sản phẩm nào bán kém theo tiêu chí
                        </div>
                    }
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">@(ViewBag.SanPhamBanKem.Count == 0 ? "Tất cả sản phẩm đều đạt yêu cầu" : "Cần xem xét chiến lược tiếp thị")</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- Best selling gift baskets -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-gift mr-2"></i>Top @ViewBag.GioQuaBanChay.Count giỏ quà bán chạy
                        </h4>
                        <span class="badge bg-white text-info">≥ @minBanChayGioQua.ToString("N0")</span>
                    </div>
                </div>
                <div class="card-body">
                    @if (ViewBag.GioQuaBanChay.Count > 0)
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th width="60%">Tên giỏ quà</th>
                                        <th width="40%" class="text-right">Số lượng bán</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var gq in ViewBag.GioQuaBanChay)
                                    {
                                        decimal tongSoLuong = Convert.ToDecimal(gq.TongSoLuong);
                                        <tr>
                                            <td>
                                                @gq.TenGq
                                                @if (gq.TenGq.Contains("8/3") || gq.TenGq.Contains("20/10"))
                                                {
                                                    <span class="badge badge-pill badge-warning ml-2">Mùa vụ</span>
                                                }
                                            </td>
                                            <td class="text-right font-weight-bold text-info">
                                                @tongSoLuong.ToString("N0")
                                                @if (tongSoLuong >= avgGioQua * 2)
                                                {
                                                    <span class="badge badge-pill badge-primary ml-2">Xuất sắc</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-info-circle mr-2"></i>
                            Không có giỏ quà nào đạt ngưỡng bán chạy
                        </div>
                    }
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">Có thể tăng cường quảng bá các giỏ quà phổ biến</small>
                </div>
            </div>
        </div>

        <!-- Poor selling gift baskets -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-secondary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-box-open mr-2"></i>Top @ViewBag.GioQuaBanKem.Count giỏ quà bán kém
                        </h4>
                        <span class="badge bg-white text-secondary">≤ @maxBanKemGioQua.ToString("N0")</span>
                    </div>
                </div>
                <div class="card-body">
                    @if (ViewBag.GioQuaBanKem.Count > 0)
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th width="60%">Tên giỏ quà</th>
                                        <th width="40%" class="text-right">Số lượng bán</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var gq in ViewBag.GioQuaBanKem)
                                    {
                                        decimal tongSoLuong = Convert.ToDecimal(gq.TongSoLuong);
                                        <tr>
                                            <td>@gq.TenGq</td>
                                            <td class="text-right font-weight-bold text-secondary">
                                                @tongSoLuong.ToString("N0")
                                                @if (tongSoLuong == 0)
                                                {
                                                    <span class="badge badge-pill badge-danger ml-2">Không bán được</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle mr-2"></i>
                            Không có giỏ quà nào bán kém theo tiêu chí
                        </div>
                    }
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">@(ViewBag.GioQuaBanKem.Count == 0 ? "Tất cả giỏ quà đều đạt yêu cầu" : "Xem xét cải tiến hoặc thay thế")</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <div class="alert alert-info">
                <i class="fas fa-lightbulb mr-2"></i>
                <strong>Gợi ý hành động:</strong>
                <ul class="mb-0">
                    <li>Sản phẩm/giỏ quà có nhãn <span class="badge badge-success">Xuất sắc</span> nên được ưu tiên quảng bá</li>
                    <li>Sản phẩm mùa vụ <span class="badge badge-warning">Mùa vụ</span> cần có chiến lược riêng theo thời điểm</li>
                    <li>Các mặt hàng <span class="badge badge-danger">Không bán được</span> cần xem xét ngừng kinh doanh hoặc cải tiến</li>
                    <li>Sản phẩm bán kém nhưng có tiềm năng cần được đánh giá lại về giá cả, vị trí trưng bày</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .card {
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s ease;
            border: none;
        }

            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            }

        .card-header {
            font-weight: 600;
            border-bottom: none;
            padding: 1rem 1.25rem;
        }

        .table th {
            border-top: none;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        .table td {
            vertical-align: middle;
            border-top: 1px solid #f1f1f1;
        }

        .badge-pill {
            font-size: 0.65rem;
            padding: 0.35em 0.65em;
            font-weight: 500;
        }

        .alert {
            border: none;
            border-left: 4px solid;
        }
    </style>
}