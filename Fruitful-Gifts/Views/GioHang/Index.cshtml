@{
    ViewData["Title"] = "Giỏ hàng";
}
@section Styles {
    <link rel="stylesheet" href="~/css/GioHang.css" />
}

@model List<Fruitful_Gifts.Database.ChiTietGioHang>

@{
    var tongTien = ViewBag.TongTien as decimal? ?? 0;
}

@functions {
    public string FormatCurrency(decimal? amount)
    {
        return string.Format(new System.Globalization.CultureInfo("vi-VN"), "{0:c0}", amount ?? 0);
    }
}

<div class="container mt-3 mb-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
            <li class="breadcrumb-item active" aria-current="page">Giỏ hàng</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-12 div-sp-gio-hang">
            @if (ViewBag.DanhSach == null || !((List<Fruitful_Gifts.Database.ChiTietGioHang>)ViewBag.DanhSach).Any())
            {
                <div class="alert alert-warning" role="alert">
                    Không có sản phẩm nào. Quay lại <a href="/" class="fw-bold text-decoration-none">cửa hàng</a> để tiếp tục mua sắm.
                </div>
            }
            else
            {
                <div class="row">
                    <div class="col-12 col-lg-8">
                        <div class="col-11 d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                <!-- Checkbox chọn tất cả -->
                                <input type="checkbox" id="checkbox-chon-tat-ca" style="width: 18px; height: 18px; accent-color: #165da3;"
                                @(ViewBag.CheckAll == true ? "checked" : "") />
                                <label for="checkbox-chon-tat-ca" class="ms-2 mb-0">Chọn tất cả</label>
                            </div>

                            <h6 class="mb-0">
                                <a href="javascript:void(0)" id="btn-xoa-tat-ca"
                                   class="line-bottom position-relative text-decoration-none text-danger">
                                    Xóa tất cả
                                </a>
                            </h6>
                        </div>

                        <div class="col-11 pt-2">
                            <div class="col-12">
                                @foreach (var item in Model)
                                {
                                    var tenSanPham = item.MaSpNavigation?.TenSp ?? item.MaGqNavigation?.TenGioQua;
                                    var hinhAnh = item.MaSpNavigation?.HinhAnh ?? item.MaGqNavigation?.HinhAnh;
                                    var giaBan = item.MaSpNavigation?.GiaBan ?? item.MaGqNavigation?.GiaBan;
                                    var id = item.MaGq ?? item.MaSp;
                                    var loai = item.MaGq != null ? "gq" : "sp";
                                    var slug = loai == "gq" ? item.MaGqNavigation?.Slug : item.MaSpNavigation?.Slug;
                                    var img = loai == "gq" ? $"~/images/gioqua/{@hinhAnh}" : $"~/images/sanpham/{@hinhAnh}";
                                    var chitiet = Url.Action(loai == "gq" ? "ChiTietGioQua" : "ChiTietSanPham",
                                    loai == "gq" ? "GioQua" : "SanPham", new { slug = slug });
                                    <div class="col-12 mb-3 position-relative">
                                        <!-- Nút xóa -->
                                        <button type="button"
                                                class="btn btn-sm btn-danger position-absolute top-0 end-0 btn-delete-item rounded"
                                                data-id="@(item.MaGq != null ? item.MaGq : item.MaSp)"
                                                data-type="@(item.MaGq != null ? "gq" : "sp")"
                                                title="Xóa sản phẩm">
                                            &times;
                                        </button>

                                        <div class="d-flex align-items-center justify-content-between border rounded p-3 shadow-sm">
                                            <!-- Ảnh sản phẩm -->
                                            <div class="d-flex align-items-center">
                                                <!-- Checkbox chọn sản phẩm -->
                                                <input type="checkbox"
                                                       class="me-3 checkbox-chon-sp"
                                                       name="chonSanPham"
                                                       value="@($"{loai}-{id}")"
                                                       data-id="@id"
                                                       data-loai="@loai"
                                                       style="width: 18px; height: 18px; accent-color: #165da3;"
                                                @(item.TrangThai == 1 ? "checked" : "")
                                                       onchange="capNhatTrangThaiCheckbox(this)" />
                                                <a href="@chitiet" class="text-decoration-none text-dark">
                                                    <img src="@Url.Content(img)" alt="@tenSanPham" class="image-item-cart" />
                                                </a>
                                                <div>
                                                    <h6 class="mb-1 text-uppercase">
                                                        <a href="@chitiet" class="text-decoration-none text-dark">@tenSanPham</a>
                                                    </h6>
                                                    <div class="d-flex align-items-center">
                                                        <button class="btn btn-sm btn-outline-secondary rounded-circle btn-update-qty"
                                                                data-id="@id"
                                                                data-loai="@loai"
                                                                data-type="giam">
                                                            <i class="fas fa-minus"></i>
                                                        </button>
                                                        <span class="mx-2 so-luong" data-id="@(item.MaGq != null ? "gq-" + item.MaGq : "sp-" + item.MaSp)">
                                                            @item.SoLuong
                                                        </span>
                                                        <button class="btn btn-sm btn-outline-secondary rounded-circle btn-update-qty"
                                                                data-id="@id"
                                                                data-loai="@loai"
                                                                data-type="tang">
                                                            <i class="fas fa-plus"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <strong class="thanh-tien" data-id="@(item.MaGq != null ? "gq-" + item.MaGq : "sp-" + item.MaSp)" 
                                                    style="white-space: nowrap;">
                                                    @FormatCurrency((item.SoLuong ?? 0) * (giaBan ?? 0))
                                                </strong>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-4 div-tong-tien bg-light border clearfix mb-3 p-2 p-lg-3 rounded-10 total">
                        <dl class="bg-light border clearfix mb-3 p-2 p-lg-3 rounded-10 total">
                            <dt class="text-uppercase font-weight-bold text-btn">
                                <h3>Tổng tiền</h3>
                            </dt>
                            <dd id="tong-tien" class="gia-tong-cong cart__summary_total font-weight-bold ml-auto mb-0">@FormatCurrency(@tongTien)</dd>

                            <div class="js-free-shipping mb-3 mt-3 position-relative progress rounded-10" data-value="50000000">
                                @if (tongTien >= 500000)
                                {
                                    <div class="progress-bar progress-bar-animated rounded-10 position-relative bg-success progress-bar-striped"
                                         role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width: 100%;">
                                        <span class="align-items-center d-inline-flex icon justify-content-center position-absolute rounded-circle bg-success"
                                              style="top: 50%; right: -5px; transform: translateY(-50%); width: 40px; height: 40px;">
                                            <i class="bi bi-truck" style="color: white; font-size: 15px;"></i>
                                        </span>
                                    </div>
                                }
                                else
                                {
                                    <div class="progress-bar progress-bar-animated rounded-10 position-relative progress-bar-striped bg-warning"
                                         role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width: 99.8%;">
                                        <span class="align-items-center d-inline-flex icon justify-content-center position-absolute rounded-circle bg-warning"
                                              style="top: 50%; right: -5px; transform: translateY(-50%); width: 40px; height: 40px;">
                                            <i class="bi bi-truck" style="color: white; font-size: 15px;"></i>
                                        </span>
                                    </div>

                                }
                            </div>
                            <div class="alert alert-info free-shipping-content js-free-shipping-text mb-0 rounded-10">
                                @if (tongTien >= 500000)
                                {
                                    <text>Đơn hàng của quý khách đã được miễn phí vận chuyển.</text>
                                }
                                else
                                {
                                    <text>Đơn hàng dưới 500.000₫ sẽ tính phí vận chuyển.</text>
                                }
                            </div>
                        </dl>

                        <form method="get" asp-controller="Payment" asp-action="Checkout">
                            <input type="hidden" name="Amount" value="@tongTien" />
                            <button type="submit" class="btn-dangnhap w-100 text-center">Thanh Toán</button>
                        </form>
                    </div>
                </div>
            }
        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>

        // Cập nhật số lượng
        $('.btn-update-qty').click(function () {
            var nut = $(this);
            var id = nut.data('id');            // MaGq hoặc MaSp
            var loai = nut.data('loai');        // "gq" hoặc "sp"
            var thaoTac = nut.data('type');     // "tang" hoặc "giam"

            var key = loai + '-' + id; // tạo key phân biệt như "gq-3" hoặc "sp-3"

            $.ajax({
                url: '/GioHang/CapNhatSoLuongAjax',
                type: 'POST',
                data: { id: id, loai: loai, type: thaoTac },
                success: function (res) {
                    if (res.success) {
                        $('span.so-luong[data-id="' + key + '"]').text(res.soLuongMoi);
                        $('strong.thanh-tien[data-id="' + key + '"]').text(res.thanhTien);
                        $('#tong-tien').text(res.tongTien);
                        $('#soLuongGio').text(res.tongSoLuongMoi);
                    }
                }
            });
        });
        // Xóa 
        $(document).on('click', '.btn-delete-item', function () {
            var button = $(this);
            var id = button.data("id");
            var type = button.data("type");

            $.ajax({
                url: '/GioHang/XoaItem',
                type: 'POST',
                data: { id: id, type: type },
                dataType: 'json',
                success: function(res) {
                    if (res.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Đã xóa!',
                            text: 'Mục đã được xóa khỏi giỏ hàng.',
                            timer: 1000,
                            showConfirmButton: false,
                            width: '300px',
                            customClass: { popup: 'swal2-sm' }
                        });

                        button.closest('.mb-3').remove();

                        let soLuongHienTai = parseInt($('#soLuongGio').text());
                        if (!isNaN(soLuongHienTai) && soLuongHienTai > 0) {
                            $('#soLuongGio').text(soLuongHienTai - res.soLuongBiTru);
                        }

                        $('#tong-tien').text(res.tongTienMoi.toLocaleString('vi-VN') + ' ₫');
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: res.message || 'Không thể xóa mục.',
                            width: '300px',
                            customClass: { popup: 'swal2-sm' }
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.log("Lỗi ajax:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Đã xảy ra lỗi trong quá trình xóa.',
                        width: '300px',
                        customClass: { popup: 'swal2-sm' }
                    });
                }
            });
        });
        // Xóa tất cả
        $('#btn-xoa-tat-ca').click(function () {
            Swal.fire({
                title: 'Xóa toàn bộ giỏ hàng?',
                text: "Bạn có chắc muốn xóa hết sản phẩm?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Xóa tất cả',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("XoaTatCaGioHang", "GioHang")', function (res) {
                        if (res.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Đã xóa tất cả',
                                timer: 1000,
                                showConfirmButton: false
                            });

                            // XÓA giao diện giỏ hàng mà không reload
                            $('.mb-3').remove(); // hoặc class container từng sản phẩm
                            $('#soLuongGio').text('0');
                            $('#tong-tien').text('0₫');
                            $('.div-sp-gio-hang').append(`
                                <div class="alert alert-warning" role="alert">
                                    Không có sản phẩm nào. Quay lại <a href="/" class="fw-bold text-decoration-none">cửa hàng</a> để tiếp tục mua sắm.
                                </div>
                            `);

                        } else {
                            Swal.fire('Lỗi', res.message || 'Không thể xóa.', 'error');
                        }
                    });
                }
            });
        });
        // Cập nhật trạng thái
        $(document).ready(function () {
            $('#checkbox-chon-tat-ca').on('change', function () {
                const checked = $(this).is(':checked');

                $('.checkbox-chon-sp').each(function () {
                    $(this).prop('checked', checked);
                    capNhatTrangThaiCheckbox(this); 
                });
            });

            $('.checkbox-chon-sp').on('change', function () {
                const allCheckboxes = $('.checkbox-chon-sp');
                const allChecked = allCheckboxes.length === allCheckboxes.filter(':checked').length;

                $('#checkbox-chon-tat-ca').prop('checked', allChecked);

                capNhatTrangThaiCheckbox(this);
            });
        });

        function capNhatTrangThaiCheckbox(checkbox) {
            const id = checkbox.getAttribute("data-id");
            const loai = checkbox.getAttribute("data-loai");
            const trangThai = checkbox.checked;

            $.post("/GioHang/CapNhatTrangThai", {
                id: id,
                loai: loai,
                trangThai: trangThai
            }, function (res) {
                if (res.success) {
                    // Cập nhật tổng tiền trên UI
                    $("#tong-tien").text(res.tongTienMoi);
                } else {
                    alert("Cập nhật trạng thái thất bại: " + res.message);
                }
            });
        }

    </script>
}
